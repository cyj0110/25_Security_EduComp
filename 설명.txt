악성코드 교관을 맡은 최영재 소위입니다.
오늘은 악성코드 문제랑 포렌식 문제를 진행을 할텐데, 오전에는 악성코드를 풀고, 오후에는 백두현 교관님께서 포렌식 문제를 진행을 할겁니다.
악성코드 문제가 2개밖에 없기 때문에, 최대한 천천히 진행을 해보도록 하겠습니다.

# 악성코드

## 윈도우 바이너리 분석

### 개요

원격훈련체계에서 윈도우 바이너리 분석 ... 내용 읽고 다운로드 유도
1) 가상 자산(윈도우) 오픈
2) 링크 복사 안됨, 직접 보고 입력해서 파일 다운로드 후 저장
3) cmd로 파일 열어보기
4) Input Password -> 비밀번호를 입력했는데 프로그램 종료. 힌트에도 리버싱 crackme라고 되어있고, 확실히 알 수 없으니 분석 도구를 이용해 분석

---

### x32dbg로 열기, 간략 설명

설명: 프로그램을 실행시키면서 분석할 수 있는 동적 분석 도구 인터페이스와 사용방법 간단히
CPU 영역: 현재 실행중인 명령어가 뭔지, 그리고 메모리 주소 등을 확인할 수 있음.
Register 영역: EAX, EIP, Flags 같은 레지스터들의 변화 상태를 알 수 있음.
Dump 영역: 주소에 들어있는 값들을 실제 16진수 값으로 알 수 있음.
Stack 영역: 스택에 있는 데이터들을 확인할 수 있음.

F9: breakpoint까지 진행 (breakpoint는 중단점으로, 프로그램을 실행하면서 특정 명령어에 중단점을 걸어 해당 지점까지 F9로 실행시킬 수 있음.) 
F8: 함수 진입은 건너뛰고 한 루틴씩 진행 (call 함수 직접 보여주면서 테스트)
F7: 함수 진입 후 루틴 진행 (call 함수 직접 보여주면서 테스트)
F2: breakpoint 설정/해제
Ctrl + F2: 프로그램 재시작
등 등...
지금 이것들을 외울 필요는 없음. 하면서 익히기

---

### 풀이 시간 제공

힌트: F9를 눌러 Entrypoint 진입, 문자열 참조에서 중단점 설정하는 부분 알려주기.
풀이 시간은 20분

### 문제 풀이
 
내용이 어렵기 때문에 천천히 진행을 하도록 하겠습니다.

도구를 실행하고 먼저 실행해봐야 할 점, F9를 눌러 Entrypoint 진입.
EntryPoint는 프로그램이 실행될 때 가장 먼저 실행되는 시작 지점이다.
문자열 참조 -> 가시적으로 읽을 수 있는 내용들을 체크, 918666 문자열과 success, login failed 내용 체크해서 분석 시작

F8을 눌러 계속 진행, 걸리는 부분(사용자 입력 대기)
-> 동적 분석 도구는 프로그램을 실행하면서 분석할 수 있게 도와주는 도구이다. 따라서 프로그램이 실행된 화면을 같이 보면서 분석을 하면 되는데
임의로 비밀번호를 입력시 다음 명령어 줄로 넘어가는 것을 알 수 있습니다. (breakpoint 걸고 재시작, F9, F9)

실제 진입해서 확인해보면
주석에 Welcome! [Admin] Input Your password 라고 문자를 확인할 수 있고, 그 밑에 %s 서식 지정자를 확인할 수 있고, Success, The password does not match와 같이 뭔가 분기가 될것이다. 라고 추정할 수 있음.
실제로 cmp dword ptr ss:[ebp-4],0을 보면 비교해서 je (jump if equal)를 통해 점프할지 말지 결정함 (ZF가 1이면 jump, 0이면 not jump)
4011D0 함수가 실제로 문자를 입력받는 함수임을 알 수 있음.
401000 함수에서 실제 비밀번호와 비교하는 루틴을 진행하는 것을 알 수 있음.
401000 함수 진입을 하면, 진행하다보면 401051함수에서 아까 문자열 참조에서 봤던 문자를 가져오는 것을 확인할 수가 있는데 어셈블리어라 확인이 어려우니 IDA 라는 다른 도구를 통해 확인해 보도록 하겠습니다.

IDA 도구는 어셈블리어로 확인할 수도 있지만, space 키를 누르면, 함수의 분기 형태를 시각화해서 편리하게 볼 수 있습니다.
main 함수에서 password가 success냐 incorrect냐로 분기되는 것을 확인할 수 있었고, 아까 x32dbg에서 401000 함수에서 문자열 비교가 일어난다고 추측했으므로,
sub_401000 함수를 눌러 이번에는 Tab키를 눌러봅니다.
그러면 이 함수에서 사용된 수도 코드를 확인할 수가 있습니다.
이중 for문을 사용해서 i는 4번, j는 8번 반복해서 byte_41E000에 있는 배열의 값을 i + 4j의 인덱스값으로 가져와 뭔가 처리를 하고 있음을 알 수가 있습니다.

다시 x32dbg로 돌아와서, (첫번째, 두번째, 세번째, 네번째 구역 설명)
첫 번째: 1씩 증가하면서 4번의 반복을 거치는 부분
두 번째: 1씩 증가하면서 8번의 반복을 거치는 부분
세 번째: IDA에서 처럼 41E000 주소의 데이터를 가져와 연산을 진행하는 부분
마지막: cmp 최종적으로 연산되서 가져온 글자와 사용자의 입력을 비교하는 부분

마지막에, cmp 명령어를 확인할 수 있습니다.
이 명령어는 ebp-14에 있는 배열의 값을 가져와 edx와 비교하라 라는 명령어입니다.
실제 오른쪽에 레지스터를 보면 EDX에는 '9' 라는 ASCII 값이 들어가 있고, ebp-14의 값을 확인해보면 오른쪽에 주소가 19FEF8로 되어있으므로 아래 스택 화면에서 더블클릭을 하면 상대주소를 확인할 수 있습니다.
그럼 덤프에서 따라가기를 눌러보면 우리가 아까 입력한 값과 41E000에서 가져온 문자열과 비교해서 두 값이 같으면 반복문을 계속 돌고, 같지 않으면 return, 즉 프로그램이 종료되는 것을 알 수 있습니다.

ebp -14 현재 스택 주소 기준 상대주소를 확인하면 31, 즉 ASCII 값으로 '1' 즉, 저희가 입력한 값임을 알 수 있습니다.
이 값이 edx, 즉 '9'라는 ASCII 값과 다르므로, 밑의 cmp 구문은 빠져나가서 아까처럼 password incorrect가 뜰겁니다.
이거를 인위적으로 수정해서 점프하지 못하게 하는 방법이 있는데, ZF를 1로 수정해서 점프하지 못하게 합니다.
다시 진행해보면, 이번에는 EDX에 '6'이 들어와 있는 것을 확인할 수가 있습니다.
아까 첫번째 값은 '9' 두번째 값은 '6', 계속 진행해보겠습니다.
진행하면 세번째 값은 'd', 네번째 값은 'f' 임을 확인할 수가 있습니다.

96df, 문자열 참조에서 41E000에 있는 문자열, 즉 "918666" 문자열과 비교해서 확인해보면 4칸씩 뛰어넘으면서 값을 가져온다는 것을 확인할 수 있습니다.

아까 IDA에서 i 4번, j 8번으로 총 32번 반복을 해야한다는 것을 인지한채로 32번 반복해서 실제 비밀번호를 알 수도 있지만, 저희는
python코드를 사용해서 자동화시켜보겠습니다.

python idle 실행하시고
i = 0
j = 0

a = "문자열" # x32dbg에서 가져오기

for i in range(4):
    for j in range(8):
        print(a[i + 4 * j], end = '')

결과 등장, 최종적으로 우리가 찾는 비밀번호임을 알 수 있음.
실제로 cmd 창에 넣어보면 success가 뜨는 것을 확인할 수 있음.


### 전체 과정

프로그램 cmd 실행 -> x32dbg 간단하게 설명, 문자열 참조 등 -> 실제로 918666 넣어본다 -> 안되네? -> 분석 시작 -> F9 엔트리포인트 진입 -> F8 눌러보다가 멈추는 부분 찾아도 되고, 문자열 참조를 눌러서 %s -> 입력을 받고 무언가 처리를 한다는 느낌 주고 20분 풀이 시간 주기 -> %s에서 여기서 입력값 받고, 분기문 jump 보여주고 그 전에 있는 call함수가 검증 로직 함수임을 확인 ->
해당 함수에 들어가서 어셈블리를 분석 하는데 (검증 로직 복잡) -> IDA로 2중 for문 확인 -> 사진 보여주면서 해당 부분이 for문 관련 부분을 처리하는 것임을 확인하고, F8을 눌러가면서 레지스터 하나하나 변경되는 것 확인하고, 3개, 4개 정도 비교(메모장 켜서 4개씩 뛰면서 i+4j 인덱스를 가져오는 것 보여주기) -> python으로 자동화 -> 코드 따라치라고 하면 됨
 -> 해당 부분 cmd에 넣어보고 flag 확인